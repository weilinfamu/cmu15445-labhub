âœ… æºç ï¼šMoveBlocked æ˜¯ä»€ä¹ˆï¼Ÿ

/// ä¸€ä¸ªç‰¹æ®Šç±»å‹ï¼Œç”¨äºæµ‹è¯•ä¸­ç¦æ­¢ç§»åŠ¨æ„é€ å’Œç§»åŠ¨èµ‹å€¼æ“ä½œ
class MoveBlocked {
 public:
  explicit MoveBlocked(std::future<int> wait) : wait_(std::move(wait)) {}

  MoveBlocked(const MoveBlocked &) = delete;
  MoveBlocked(MoveBlocked &&that) noexcept {
    if (!that.waited_) {
      that.wait_.get();
    }
    that.waited_ = waited_ = true;
  }

  auto operator=(const MoveBlocked &) -> MoveBlocked & = delete;
  auto operator=(MoveBlocked &&that) noexcept -> MoveBlocked & {
    if (!that.waited_) {
      that.wait_.get();
    }
    that.waited_ = waited_ = true;
    return *this;
  }

  bool waited_{false};
  std::future<int> wait_;
};
--------------------------------------------------------------------------------------------------
âœ… é‚£ä¹ˆï¼ŒMoveBlocked(std::future<int> wait) æ˜¯ä»€ä¹ˆæ„æ€ï¼Ÿ

std::future<int> f = ...;
MoveBlocked m(std::move(f));  // âœ… ä½ æŠŠè¿™ä¸ª future äº¤ç»™ m ç®¡ç†
ä¹Ÿå°±æ˜¯è¯´ï¼š

MoveBlocked çš„æ„é€ å‡½æ•°æ¥æ”¶è¿™ä¸ª â€œfutureâ€ å¯¹è±¡

å®ƒè´Ÿè´£å°†æ¥æŸä¸ªæ—¶é—´ .get() æ‹¿åˆ°ç»“æœ



--------------------------------------------------------------------------------------------------
âœ… std::promise / std::future çš„æœ¬è´¨ï¼šçº¿ç¨‹é—´çš„â€œä¸€æ¬¡æ€§é€šçŸ¥é€šé“â€
âœ… æ˜¯è°å†™ï¼Ÿè°è¯»ï¼Ÿ
å¯¹è±¡	ä½œç”¨	è°ä½¿ç”¨
promise	å†™ç«¯/è®¾ç½®ç»“æœ	å­çº¿ç¨‹
future	è¯»ç«¯/è·å–ç»“æœ	ä¸»çº¿ç¨‹

è¿™å°±æ˜¯ä¸€ä¸ª å•å‘é€šé“ï¼Œå¯ä»¥ï¼š

è®¾ç½®å€¼ âœ…

è¯»å–å€¼ âœ…

è®¾ç½®å¼‚å¸¸ â—

å®ƒåº•å±‚åŸºäºï¼š

äº’æ–¥é”ï¼ˆmutexï¼‰

æ¡ä»¶å˜é‡ï¼ˆcond_varï¼‰

ä¿¡å·é€šçŸ¥ï¼ˆnotify_one()ï¼‰

âœ… æ‰€ä»¥ä½ è¯´å¾—å¯¹ï¼š
promise.set_value() å°±åƒæ˜¯ä¸€ä¸ªä¿¡å·é€šçŸ¥
future.get() å°±åƒæ˜¯ä¸€ä¸ªé˜»å¡ç­‰å¾…ç›´åˆ°æœ‰é€šçŸ¥ä¸ºæ­¢

âœ… ç±»æ¯”ç³»ç»Ÿè°ƒç”¨ epoll / poll çš„è§’åº¦ï¼š
æ–¹é¢	std::promise/future	epoll / poll
è®¾è®¡å±‚æ¬¡	C++ æ ‡å‡†åº“	æ“ä½œç³»ç»Ÿå†…æ ¸å±‚
é€šä¿¡æ¨¡å‹	ä¸€æ¬¡æ€§åŒæ­¥é€šä¿¡	å¤šæ¬¡æ€§äº‹ä»¶é©±åŠ¨ç›‘å¬
é€šçŸ¥æœºåˆ¶	set_value â†’ å”¤é†’ get()	å†…æ ¸äº‹ä»¶è§¦å‘ â†’ å”¤é†’ç›‘å¬è€…
é˜»å¡æ–¹	future.get() é˜»å¡	epoll_wait() é˜»å¡
å”¤é†’æœºåˆ¶	promise å†…éƒ¨æ¡ä»¶å˜é‡é€šçŸ¥	å†…æ ¸ä¸­æ–­è§¦å‘ FD æ´»è·ƒé€šçŸ¥
ä½¿ç”¨åœºæ™¯	çº¿ç¨‹ä¹‹é—´ä¼ å€¼ï¼ˆä¸€æ¬¡ï¼‰	å¤§é‡ IO äº‹ä»¶å¹¶å‘é«˜æ•ˆç›‘å¬


[promise/future]                    [epoll/poll]
 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”                          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
 â”‚ thread â”‚                          â”‚  process   â”‚
 â”‚   T1   â”‚ set_value(42) â†’ ğŸ”” â†’     â”‚ epoll_wait â”‚
 â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜                          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â†“                                    â†“
 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”                         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
 â”‚future  â”‚ â† get() â† blocks        â”‚ äº‹ä»¶è§¦å‘   â”‚
 â”‚   T0   â”‚                         â”‚  fd æ´»è·ƒ   â”‚
 â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜                         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

âœ… æœ¬è´¨åŒºåˆ«
é¡¹ç›®	std::promise/future	epoll / poll
é€šä¿¡æ–¹å‘	å•æ¬¡å‘é€ + é˜»å¡ç­‰å¾…	å¤šäº‹ä»¶ç›‘å¬ + éé˜»å¡å”¤é†’
æ˜¯å¦å¯å¤ç”¨	âŒ ä¸€æ¬¡æ€§ç”¨å®Œ	âœ… æ”¯æŒåå¤ç›‘å¬
å¯ä¼ é€’å€¼	âœ… å¯ä»¥ä¼ ç»“æœï¼ˆintã€å¯¹è±¡ç­‰ï¼‰	âŒ åªçŸ¥é“å“ªä¸ª fd æ´»è·ƒï¼Œä¸ä¼ æ•°æ®
åº•å±‚ä¾èµ–	C++ æ¡ä»¶å˜é‡ + mutex	Linux å†…æ ¸ select/poll/epoll
--------------------------------
std::promise / futureï¼š

æ›´åƒ â€œä¸€æ¬¡æ€§çš„æ¶ˆæ¯é˜Ÿåˆ—+é˜»å¡æ¥æ”¶â€

ç”¨äºçº¿ç¨‹é—´é€šä¿¡æˆ–ä»»åŠ¡ç»“æœè·å–

æ”¯æŒä¼ å€¼ã€å¼‚å¸¸

epoll / pollï¼š

æ›´åƒ â€œå¤šè·¯äº‹ä»¶æ³¨å†Œ+å†…æ ¸é€šçŸ¥â€

ç”¨äº I/O å¤šè·¯å¤ç”¨ï¼Œé«˜å¹¶å‘ç½‘ç»œæœåŠ¡å™¨ï¼ˆå¦‚ Nginxï¼‰

----------------------------------


----------------------------------------------------------------------------------------------------
#include <future>	å¼•å…¥å¼‚æ­¥é€šä¿¡å·¥å…·ï¼šstd::promise å’Œ std::future


#include <iostream>
#include <thread>
#include <future>  // ğŸ’¡ future å°±åœ¨è¿™

int Work() {
  std::this_thread::sleep_for(std::chrono::seconds(2));  // å‡è£…å¹²2ç§’çš„æ´»
  return 42;  // å¹²å®Œè¿”å›ä¸€ä¸ªç»“æœ
}

int main() {

//promise æ˜¯å†™ç«¯ï¼Œfuture æ˜¯è¯»ç«¯ã€‚é€šè¿‡è¿™ä¸ª pair å®ç°çº¿ç¨‹é—´é€šä¿¡
  std::promise<int> p;                      // ğŸ æˆ‘åˆ›å»ºä¸€ä¸ªâ€œæ‰¿è¯ºâ€ï¼šæˆ‘ä»¥åä¼šç»™ä½ ä¸€ä¸ª int
  std::future<int> f = p.get_future();      // ğŸ“¬ æ‹¿åˆ°å¯¹åº”çš„â€œæ”¶ä»¶ç®± futureâ€

//[&p]ï¼šé€šè¿‡å¼•ç”¨æ•è· promise å¯¹è±¡
  std::thread t([&p]() {                    // ğŸ’¡ å¼€ä¸ªçº¿ç¨‹ï¼Œå¹²ç‚¹äº‹
    std::this_thread::sleep_for(std::chrono::seconds(2));
    p.set_value(42);                        // ğŸ’¥ ä¸¤ç§’åï¼Œç»“æœæ¥äº†ï¼æ‰¿è¯ºå…‘ç°
  });

  std::cout << "ç­‰ç»“æœ...\n";
  int result = f.get();                     // â³ å¡ä½è¿™é‡Œï¼Œä¸€å®šç­‰åˆ°ç»“æœä¸ºæ­¢
  std::cout << "ç»“æœæ˜¯ï¼š" << result << "\n";

  t.join();
}







