âœ… æºç ï¼šMoveBlocked æ˜¯ä»€ä¹ˆï¼Ÿ
cpp
Copy
Edit
/// ä¸€ä¸ªç‰¹æ®Šç±»å‹ï¼Œç”¨äºæµ‹è¯•ä¸­ç¦æ­¢ç§»åŠ¨æ„é€ å’Œç§»åŠ¨èµ‹å€¼æ“ä½œ
class MoveBlocked {
 public:
  explicit MoveBlocked(std::future<int> wait) : wait_(std::move(wait)) {}

  MoveBlocked(const MoveBlocked &) = delete;
  MoveBlocked(MoveBlocked &&that) noexcept {
    if (!that.waited_) {
      that.wait_.get();
    }
    that.waited_ = waited_ = true;
  }

  auto operator=(const MoveBlocked &) -> MoveBlocked & = delete;
  auto operator=(MoveBlocked &&that) noexcept -> MoveBlocked & {
    if (!that.waited_) {
      that.wait_.get();
    }
    that.waited_ = waited_ = true;
    return *this;
  }

  bool waited_{false};
  std::future<int> wait_;
};
--------------------------------------------------------------------------------------------------
#include <future>	å¼•å…¥å¼‚æ­¥é€šä¿¡å·¥å…·ï¼šstd::promise å’Œ std::future


#include <iostream>
#include <thread>
#include <future>  // ğŸ’¡ future å°±åœ¨è¿™

int Work() {
  std::this_thread::sleep_for(std::chrono::seconds(2));  // å‡è£…å¹²2ç§’çš„æ´»
  return 42;  // å¹²å®Œè¿”å›ä¸€ä¸ªç»“æœ
}

int main() {

//promise æ˜¯å†™ç«¯ï¼Œfuture æ˜¯è¯»ç«¯ã€‚é€šè¿‡è¿™ä¸ª pair å®ç°çº¿ç¨‹é—´é€šä¿¡
  std::promise<int> p;                      // ğŸ æˆ‘åˆ›å»ºä¸€ä¸ªâ€œæ‰¿è¯ºâ€ï¼šæˆ‘ä»¥åä¼šç»™ä½ ä¸€ä¸ª int
  std::future<int> f = p.get_future();      // ğŸ“¬ æ‹¿åˆ°å¯¹åº”çš„â€œæ”¶ä»¶ç®± futureâ€

//[&p]ï¼šé€šè¿‡å¼•ç”¨æ•è· promise å¯¹è±¡
  std::thread t([&p]() {                    // ğŸ’¡ å¼€ä¸ªçº¿ç¨‹ï¼Œå¹²ç‚¹äº‹
    std::this_thread::sleep_for(std::chrono::seconds(2));
    p.set_value(42);                        // ğŸ’¥ ä¸¤ç§’åï¼Œç»“æœæ¥äº†ï¼æ‰¿è¯ºå…‘ç°
  });

  std::cout << "ç­‰ç»“æœ...\n";
  int result = f.get();                     // â³ å¡ä½è¿™é‡Œï¼Œä¸€å®šç­‰åˆ°ç»“æœä¸ºæ­¢
  std::cout << "ç»“æœæ˜¯ï¼š" << result << "\n";

  t.join();
}






